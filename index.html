<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="app-version" content="1.0.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Our Group Calendar</title>
    <!-- Tailwind CSS for styling -->
    <script src="./js/tailwindcss.js"></script>
    <!-- Confetti Library -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script> -->
    <script src="./js/confrtti_browser.js"></script>
    <!-- Google Fonts -->
    <!-- <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap" rel="stylesheet"> -->
    <link rel="stylesheet" href="./css/googleapis.css">
    <!-- FontAwesome for Icons -->
    <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"> -->
    <link rel="stylesheet" href="./css/awesome.css">

    <style>
        body {
            font-family: 'Nunito', sans-serif;
            overflow: hidden; /* Prevent scrolling */
        }

        /* BACKGROUND IMAGE SETTINGS */
        .bg-image {
            /* åœ¨è¿™é‡Œæ›¿æ¢ä½ ä»¬çš„åˆç…§ URL */
            background-image: url('https://loltacticstool.online/shu.png');
            background-size: cover;
            background-position: center;
            filter: brightness(0.5); /* ç¨å¾®è°ƒæš—ä¸€ç‚¹ï¼Œè®©æ–‡å­—æ›´æ¸…æ™° */
        }

        /* Glassmorphism Effect */
        .glass {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }

        .glass-dark {
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Special Day Pulse Animation */
        @keyframes pulse-gold {
            0% { box-shadow: 0 0 0 0 rgba(250, 204, 21, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(250, 204, 21, 0); }
            100% { box-shadow: 0 0 0 0 rgba(250, 204, 21, 0); }
        }

        .special-day-marker {
            animation: pulse-gold 2s infinite;
        }

        /* Lyrics Styling */
        .lyrics-container {
            mask-image: linear-gradient(to bottom, transparent, black 15%, black 85%, transparent);
            -webkit-mask-image: linear-gradient(to bottom, transparent, black 15%, black 85%, transparent);
        }
        
        .lyric-line {
            opacity: 0.5;
            transform: scale(0.95);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .lyric-line.active {
            opacity: 1;
            transform: scale(1.05);
            font-weight: bold;
            color: #fbbf24; /* Amber-400 */
            text-shadow: 0 0 10px rgba(251, 191, 36, 0.5);
        }

        /* Rotating Disc Animation for Player */
        .spin-slow {
            animation: spin 8s linear infinite;
        }
        .paused-spin {
            animation-play-state: paused;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Scrollbar hiding */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .loader {
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top: 3px solid #fff;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        
    </style>
</head>
<body class="h-screen w-screen bg-black text-white relative">

    <!-- Actual Audio Element (Controlled by JS) -->
    <audio id="main-audio" crossOrigin="anonymous" preload="none"></audio>
    <!-- TTS Audio Element -->
    <audio id="tts-player" crossOrigin="anonymous" preload="none"></audio>

    <!-- BACKGROUND LAYER -->
    <div id="bg-layer" class="absolute inset-0 bg-image z-0"></div>

    <!-- WELCOME OVERLAY -->
    <div id="start-screen" class="absolute inset-0 z-50 flex flex-col items-center justify-center bg-black/80 transition-opacity duration-700">
        <div class="text-center space-y-6 p-6">
            <h1 class="text-4xl font-bold text-white tracking-widest">MEMORIES</h1>
            <p class="text-gray-300">Tap to start the music</p>
            <button id="enter-btn" class="glass px-8 py-4 rounded-full text-xl font-semibold text-white hover:bg-white/20 transition">
                Enter
            </button>
        </div>
    </div>

    <!-- MUSIC PLAYER: FLOATING BUTTON (Minimized) -->
    <div id="music-fab" class="absolute top-6 right-6 z-30 transition-transform duration-300 hover:scale-110 hidden opacity-0 cursor-pointer">
        <div class="glass w-14 h-14 rounded-full flex items-center justify-center relative">
            <div id="fab-spin" class="absolute inset-1 rounded-full border-2 border-white/30 border-t-purple-400 spin-slow paused-spin"></div>
            <i class="fa-solid fa-music text-xl"></i>
        </div>
    </div>

    <!-- MUSIC PLAYER: EXPANDED OVERLAY -->
    <div id="music-overlay" class="fixed inset-0 z-40 flex flex-col justify-end bg-black/60 backdrop-blur-md translate-y-full transition-transform duration-500 ease-out">
        
        <!-- Drag Handle / Close Area -->
        <div id="close-music-area" class="flex-grow w-full transparent"></div>

        <!-- Player Card -->
        <div class="glass-dark w-full rounded-t-3xl p-6 pb-10 max-h-[85vh] flex flex-col shadow-2xl border-t border-white/10">
            
            <!-- Close Button -->
            <div class="w-full flex justify-center mb-2">
                <div class="w-12 h-1.5 bg-white/20 rounded-full"></div>
            </div>
            
            <div class="flex justify-between items-center mb-6">
                <div class="flex items-center gap-4">
                    <div id="album-art" class="w-16 h-16 rounded-xl bg-gradient-to-br from-purple-500 to-blue-500 shadow-lg flex items-center justify-center text-2xl spin-slow paused-spin">
                        ğŸµ
                    </div>
                    <div>
                        <h3 id="song-title" class="font-bold text-lg truncate max-w-[200px]">Song Title</h3>
                        <p id="song-artist" class="text-xs text-gray-400">Artist Name</p>
                    </div>
                </div>
                <button id="minimize-btn" class="p-3 text-white/50 hover:text-white">
                    <i class="fa-solid fa-chevron-down text-xl"></i>
                </button>
            </div>

            <!-- Lyrics Area -->
            <div id="lyrics-container" class="lyrics-container h-48 md:h-64 overflow-y-auto no-scrollbar text-center space-y-4 mb-6 relative px-4">
                <p class="text-white/30 italic mt-20">Lyrics will appear here...</p>
            </div>

            <!-- Progress Bar -->
            <div class="w-full bg-white/10 h-1.5 rounded-full mb-6 cursor-pointer group" id="progress-container">
                <div id="progress-bar" class="bg-purple-500 h-full rounded-full w-0 relative group-hover:bg-purple-400 transition-all">
                    <div class="absolute right-0 top-1/2 -translate-y-1/2 w-3 h-3 bg-white rounded-full opacity-0 group-hover:opacity-100 shadow-md"></div>
                </div>
            </div>

            <!-- Controls -->
            <div class="flex justify-between items-center px-4">
                <button id="prev-song" class="text-white/70 hover:text-white transition"><i class="fa-solid fa-backward-step text-2xl"></i></button>
                <button id="play-pause" class="w-16 h-16 bg-white text-black rounded-full flex items-center justify-center hover:scale-105 transition shadow-lg shadow-purple-500/20">
                    <i class="fa-solid fa-play text-2xl pl-1" id="play-icon"></i>
                </button>
                <button id="next-song" class="text-white/70 hover:text-white transition"><i class="fa-solid fa-forward-step text-2xl"></i></button>
            </div>

        </div>
    </div>

    <!-- MAIN CALENDAR CONTENT -->
    <div id="main-content" class="relative z-10 h-full flex flex-col items-center justify-center p-4 hidden opacity-0 transition-opacity duration-1000">
        
        <!-- Calendar Container -->
        <div class="glass w-full max-w-md rounded-3xl p-6 text-center relative overflow-hidden flex flex-col max-h-[75vh]">
            
            <!-- Header -->
            <div class="mb-4 flex flex-col items-center shrink-0">
                <div class="flex justify-between items-center w-full mb-2">
                    <button id="prev-month" class="p-2 text-white/70 hover:text-white">&lt;</button>
                    <h2 id="month-year" class="text-2xl font-bold text-white drop-shadow-md"></h2>
                    <button id="next-month" class="p-2 text-white/70 hover:text-white">&gt;</button>
                </div>
                <!-- Fortune Button -->
                <button id="fortune-btn" class="text-xs bg-purple-500/30 hover:bg-purple-500/50 px-3 py-1 rounded-full text-purple-100 transition flex items-center gap-1 border border-purple-400/30">
                    ğŸ”® ä»Šæ—¥è¿åŠ¿
                </button>
            </div>

            <!-- Days of Week -->
            <div class="grid grid-cols-7 gap-2 mb-2 text-xs font-semibold text-white/60 uppercase tracking-wide shrink-0">
                <div>Sun</div>
                <div>Mon</div>
                <div>Tue</div>
                <div>Wed</div>
                <div>Thu</div>
                <div>Fri</div>
                <div>Sat</div>
            </div>

            <!-- Calendar Grid -->
            <div id="calendar-grid" class="grid grid-cols-7 gap-2 overflow-y-auto flex-grow no-scrollbar">
                <!-- Days injected by JS -->
            </div>

            <!-- AI Quote Footer -->
            <div class="mt-4 pt-4 border-t border-white/10 shrink-0">
                <p class="text-sm text-white/80 italic min-h-[3em]" id="daily-quote">"Best friends are the people in life that make you laugh a little louder..."</p>
            </div>
        </div>
    </div>

    <!-- MODAL FOR EVENTS -->
    <div id="event-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 hidden backdrop-blur-sm p-4">
        <div class="glass bg-black/40 rounded-2xl p-6 max-w-sm w-full text-center transform transition-all scale-95 opacity-0 flex flex-col max-h-[80vh] overflow-y-auto" id="modal-content">
            <div class="text-5xl mb-4" id="modal-emoji">ğŸ“…</div>
            <h3 class="text-2xl font-bold mb-2" id="modal-title">Title</h3>
            <p class="text-white/80 mb-6" id="modal-desc">Description</p>
            <button onclick="closeModal()" class="text-white/50 hover:text-white text-sm mt-2 underline">Close</button>
        </div>
    </div>

    <script>
        // --- 0. ç‰ˆæœ¬ç®¡ç†å’Œæ— æ„Ÿè‡ªåŠ¨æ›´æ–°æ£€æµ‹ ---
        const APP_VERSION = '1.0.0'; // æ¯æ¬¡æ›´æ–°æ—¶ä¿®æ”¹è¿™ä¸ªç‰ˆæœ¬å·
        
        // æ£€æŸ¥æ›´æ–°å‡½æ•°ï¼ˆåªåœ¨é¡µé¢åŠ è½½æ—¶æ‰§è¡Œä¸€æ¬¡ï¼‰
        async function checkForUpdate() {
            try {
                const currentVersion = APP_VERSION;
                
                // ä»æœåŠ¡å™¨è·å–æœ€æ–°ç‰ˆæœ¬å·
                const htmlResponse = await fetch(window.location.href + '?v=' + Date.now(), {
                    cache: 'no-cache',
                    headers: {
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    }
                });
                
                const htmlText = await htmlResponse.text();
                const versionMatch = htmlText.match(/<meta\s+name=["']app-version["']\s+content=["']([^"']+)["']/i);
                
                if (versionMatch && versionMatch[1] !== currentVersion) {
                    // å‘ç°æ–°ç‰ˆæœ¬ï¼Œè‡ªåŠ¨åˆ·æ–°ï¼ˆæ— æ„Ÿæ›´æ–°ï¼‰
                    console.log('å‘ç°æ–°ç‰ˆæœ¬ï¼Œè‡ªåŠ¨åˆ·æ–°:', versionMatch[1]);
                    location.reload(true);
                    return true;
                }
                
                // å¤‡ç”¨æ–¹æ¡ˆï¼šæ£€æŸ¥æ–‡ä»¶ä¿®æ”¹æ—¶é—´
                const lastModified = htmlResponse.headers.get('Last-Modified');
                const storedLastModified = localStorage.getItem('app-last-modified');
                
                if (lastModified && lastModified !== storedLastModified && storedLastModified) {
                    // æ–‡ä»¶å·²æ›´æ–°ï¼Œè‡ªåŠ¨åˆ·æ–°
                    console.log('æ£€æµ‹åˆ°æ–‡ä»¶æ›´æ–°ï¼Œè‡ªåŠ¨åˆ·æ–°');
                    localStorage.setItem('app-last-modified', lastModified);
                    location.reload(true);
                    return true;
                } else if (lastModified) {
                    localStorage.setItem('app-last-modified', lastModified);
                }
                
            } catch (error) {
                // é™é»˜å¤±è´¥ï¼Œä¸å½±å“é¡µé¢æ­£å¸¸ä½¿ç”¨
                console.log('æ£€æŸ¥æ›´æ–°å¤±è´¥:', error);
            }
            return false;
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåç«‹å³æ£€æŸ¥æ›´æ–°ï¼ˆåªæ£€æŸ¥ä¸€æ¬¡ï¼‰
        window.addEventListener('load', () => {
            // å»¶è¿Ÿæ£€æŸ¥ï¼Œé¿å…å½±å“é¡µé¢åˆå§‹åŠ è½½
            setTimeout(() => {
                checkForUpdate();
            }, 2000);
        });
        
        // --- 0. SERVICE WORKER æ³¨å†Œï¼ˆç¼“å­˜ç­–ç•¥ï¼‰---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // å…ˆå°è¯•æ³¨é”€æ—§çš„ Service Workerï¼ˆå¦‚æœæœ‰é—®é¢˜ï¼‰
                navigator.serviceWorker.getRegistrations().then((registrations) => {
                    return Promise.all(
                        registrations.map((registration) => {
                            if (registration.active && registration.active.scriptURL.includes('sw.js')) {
                                console.log('[Service Worker] å‘ç°æ—§ç‰ˆæœ¬ï¼Œå°è¯•æ›´æ–°...');
                            }
                        })
                    );
                }).catch(() => {});

                navigator.serviceWorker.register('./sw.js', { scope: './' })
                    .then((registration) => {
                        console.log('[Service Worker] æ³¨å†ŒæˆåŠŸ:', registration.scope);
                        
                        // æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ–°
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            if (newWorker) {
                                newWorker.addEventListener('statechange', () => {
                                    if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                        console.log('[Service Worker] æ–°ç‰ˆæœ¬å¯ç”¨ï¼Œè‡ªåŠ¨åˆ·æ–°');
                                        // è‡ªåŠ¨åˆ·æ–°ä»¥è·å–æ–°ç‰ˆæœ¬ï¼ˆæ— æ„Ÿæ›´æ–°ï¼‰
                                        location.reload(true);
                                    } else if (newWorker.state === 'activated') {
                                        console.log('[Service Worker] æ–°ç‰ˆæœ¬å·²æ¿€æ´»');
                                        // æ–°ç‰ˆæœ¬æ¿€æ´»åï¼Œæ£€æŸ¥é¡µé¢æ›´æ–°
                                        checkForUpdate();
                                    }
                                });
                            }
                        });
                    })
                    .catch((error) => {
                        console.error('[Service Worker] æ³¨å†Œå¤±è´¥:', error);
                        console.warn('[Service Worker] å°†ä½¿ç”¨æµè§ˆå™¨åŸç”Ÿç¼“å­˜');
                        // Service Worker å¤±è´¥ä¸å½±å“é¡µé¢åŠŸèƒ½ï¼Œåªæ˜¯æ— æ³•ä½¿ç”¨é«˜çº§ç¼“å­˜
                    });

                // ç›‘å¬ Service Worker æ¶ˆæ¯
                if (navigator.serviceWorker.controller) {
                    navigator.serviceWorker.addEventListener('message', (event) => {
                        console.log('[Service Worker] æ”¶åˆ°æ¶ˆæ¯:', event.data);
                    });
                }
            });
        } else {
            console.log('[Service Worker] æµè§ˆå™¨ä¸æ”¯æŒ Service Workerï¼Œå°†ä½¿ç”¨æµè§ˆå™¨åŸç”Ÿç¼“å­˜');
        }

        // --- 1. PLAYLIST & LYRICS CONFIGURATION ---
        const playlist = [
            {
                title: "å™—å™—å®‡å®™è§‚å¯Ÿé˜Ÿ",
                artist: "ç²¾ç¥æ–‡æ˜å»ºè®¾å§”å‘˜ä¼š",
                url: "https://loltacticstool.online/pupu-china.mp3",
                lyrics: `
[00:00.00] (Music Start)
[00:07.00] ä»Šå¤œæ˜Ÿå…‰ç¿çƒ‚ï¼Œæˆ‘ä»¬ç›¸èšåœ¨ä¸€èµ·
[00:10.00] ç²¾ç¥æ–‡æ˜å»ºè®¾å§”å‘˜ä¼šï¼Œå‹è°Šæ°¸ä¸ä¼šæ•£
[00:14.00] æ¬¢å£°ç¬‘è¯­ä¸åœæ­‡ï¼Œå¿«ä¹æ°¸è¿œåœ¨èº«è¾¹
[00:18.00] å™—å™—å®‡å®™è§‚å¯Ÿé˜Ÿï¼Œæ¢ç´¢ç¾å¥½çš„æ˜å¤©
[00:21.00] å™—å™—å®‡å®™è§‚å¯Ÿé˜Ÿï¼Œæˆ‘ä»¬æ˜¯æœ€ä½³æ‹æ¡£
[00:25.00] æ‰‹ç‰µæ‰‹è‚©å¹¶è‚©ï¼Œå‹è°Šåœ°ä¹…å¤©é•¿
[00:28.00] ç²¾ç¥æ–‡æ˜å»ºè®¾ï¼Œè®©å¿ƒçµæ›´åŠ æ˜äº®
[00:32.00] å™—å™—å®‡å®™è§‚å¯Ÿé˜Ÿï¼Œæ°¸è¿œä¸æ•£åœº
[00:37.00] æ¯ä¸€æ¬¡çš„èšä¼šï¼Œéƒ½æ˜¯çè´µå›å¿†
[00:40.50] åˆ†äº«å¿«ä¹æ—¶å…‰ï¼Œæ¶ˆé™¤æ‰€æœ‰ç–²æƒ«
[00:44.00] æ— è®ºèµ°åˆ°å“ªé‡Œï¼Œå¿ƒä¸­éƒ½æœ‰ä½ ä»¬
[00:46.80] å™—å™—å®‡å®™çš„æ—…ç¨‹ï¼Œå› ä¸ºæœ‰ä½ ä»¬è€Œå®Œç¾
[00:52.70] ä»æ—¥å‡ºåˆ°æ—¥è½ï¼Œä»æ˜¥å¤©åˆ°å†¬å¤©
[00:56.00] å‹è°Šå¦‚åŒç¾é…’ï¼Œè¶Šé™ˆè¶Šé¦™é†‡
[01:00.00] ç²¾ç¥æ–‡æ˜å»ºè®¾ï¼Œè®©ç”Ÿæ´»æ›´ç¾å¥½
[01:03.00] å™—å™—å®‡å®™è§‚å¯Ÿé˜Ÿï¼Œæ°¸è¿œå¿ƒè¿å¿ƒ
[01:07.80] å™—å™—å®‡å®™è§‚å¯Ÿé˜Ÿï¼Œæˆ‘ä»¬æ˜¯æœ€ä½³æ‹æ¡£
[01:11.80] æ‰‹ç‰µæ‰‹è‚©å¹¶è‚©ï¼Œå‹è°Šåœ°ä¹…å¤©é•¿
[01:15.40] ç²¾ç¥æ–‡æ˜å»ºè®¾ï¼Œè®©å¿ƒçµæ›´åŠ æ˜äº®
[01:19.00] å™—å™—å®‡å®™è§‚å¯Ÿé˜Ÿï¼Œæ°¸è¿œä¸æ•£åœº
[01:45.00] (Music End)
                `
            },
            {
                title: "Friendship Days",
                artist: "Our Group",
                url: "https://cdn.pixabay.com/download/audio/2022/05/27/audio_1808fbf07a.mp3",
                lyrics: `
[00:00.00]Instrumental Intro...
[00:05.00]Remember when we first met?
[00:09.00]Walking down that street...
[00:13.00]Laughing at everything.
[00:18.00]Time flies so fast.
[00:22.00]But we are still here.
[00:26.00]Best friends forever.
[00:30.00](Music playing...)
                `
            }
        ];

        // --- 2. MUSIC PLAYER LOGIC ---
        let audio = document.getElementById('main-audio');
        const playBtn = document.getElementById('play-pause');
        const playIcon = document.getElementById('play-icon');
        const prevSongBtn = document.getElementById('prev-song');
        const nextSongBtn = document.getElementById('next-song');
        const musicFab = document.getElementById('music-fab');
        const fabSpin = document.getElementById('fab-spin');
        const musicOverlay = document.getElementById('music-overlay');
        const minimizeBtn = document.getElementById('minimize-btn');
        const closeMusicArea = document.getElementById('close-music-area');
        const albumArt = document.getElementById('album-art');
        
        const uiTitle = document.getElementById('song-title');
        const uiArtist = document.getElementById('song-artist');
        const uiLyrics = document.getElementById('lyrics-container');
        const progressBar = document.getElementById('progress-bar');
        const progressContainer = document.getElementById('progress-container');

        let currentSongIndex = 0;
        let parsedLyrics = [];
        let isPlaying = false;

        // Parse LRC String into Array of Objects
        function parseLRC(lrcText) {
            const lines = lrcText.split('\n');
            const result = [];
            const timeReg = /\[(\d{2}):(\d{2})\.(\d{2,3})\]/;
            
            lines.forEach(line => {
                const match = timeReg.exec(line);
                if (match) {
                    const min = parseInt(match[1]);
                    const sec = parseInt(match[2]);
                    const ms = parseInt(match[3].padEnd(3, '0')); // Handle 2 or 3 digit ms
                    const time = min * 60 + sec + ms / 1000;
                    const text = line.replace(timeReg, '').trim();
                    if(text) result.push({ time, text });
                }
            });
            return result;
        }

        // é¢„ç¼“å­˜éŸ³é¢‘æ–‡ä»¶çš„å‡½æ•°
        async function precacheAudio(url) {
            if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
                try {
                    // é€šè¿‡ Service Worker ç¼“å­˜éŸ³é¢‘
                    const response = await fetch(url, { cache: 'force-cache' });
                    if (response.ok) {
                        console.log('[ç¼“å­˜] éŸ³é¢‘å·²ç¼“å­˜:', url);
                    }
                } catch (error) {
                    console.log('[ç¼“å­˜] éŸ³é¢‘ç¼“å­˜å¤±è´¥:', url, error);
                }
            }
        }

        // è·Ÿè¸ªå½“å‰åŠ è½½çš„æ­Œæ›² URLï¼Œé¿å…å¤„ç†æ—§çš„é”™è¯¯äº‹ä»¶
        let currentLoadingUrl = '';
        let audioErrorHandled = false;
        
        function loadSong(index) {
            const song = playlist[index];
            
            // å…ˆåœæ­¢å½“å‰æ’­æ”¾
            if (!audio.paused) {
                audio.pause();
            }
            
            // ç§»é™¤æ‰€æœ‰æ—§çš„äº‹ä»¶ç›‘å¬å™¨ï¼ˆé€šè¿‡å…‹éš†å…ƒç´ ï¼‰
            const oldAudio = audio;
            const newAudio = oldAudio.cloneNode();
            oldAudio.parentNode.replaceChild(newAudio, oldAudio);
            audio = newAudio;
            
            // è®¾ç½®æ–°çš„éŸ³é¢‘æº
            uiTitle.innerText = song.title;
            uiArtist.innerText = song.artist;
            
            // æ›´æ–°å½“å‰åŠ è½½çš„ URL
            currentLoadingUrl = song.url;
            audioErrorHandled = false;
            
            // è®¾ç½®éŸ³é¢‘æº
            // å¯¹äºè·¨åŸŸéŸ³é¢‘ï¼Œå…ˆå°è¯•ä¸ä½¿ç”¨ crossOriginï¼ˆæŸäº› CDN ä¸æ”¯æŒ CORSï¼‰
            if (song.url.startsWith('http') && !song.url.includes(location.hostname)) {
                // è·¨åŸŸéŸ³é¢‘ï¼Œå…ˆå°è¯•ä¸ä½¿ç”¨ crossOrigin
                audio.crossOrigin = null;
            } else {
                // åŒåŸŸéŸ³é¢‘ï¼Œå¯ä»¥ä½¿ç”¨ crossOrigin
                audio.crossOrigin = 'anonymous';
            }
            audio.src = song.url;
            
            // æ·»åŠ ç»Ÿä¸€çš„é”™è¯¯å¤„ç†ï¼ˆåªæ·»åŠ ä¸€æ¬¡ï¼‰- é™é»˜å¤„ç†å¤§éƒ¨åˆ†é”™è¯¯
            audio.addEventListener('error', function onError(e) {
                // å»¶è¿Ÿæ£€æŸ¥ï¼Œé¿å…åœ¨åˆ‡æ¢æ­Œæ›²æ—¶è¯¯æŠ¥
                setTimeout(() => {
                    // æ£€æŸ¥ src æ˜¯å¦ä¸ºç©ºï¼ˆå¯èƒ½æ˜¯åˆ‡æ¢æ­Œæ›²æ—¶æ¸…ç©ºäº†ï¼‰
                    if (!audio.src || audio.src === '' || audio.src === window.location.href) {
                        return; // é™é»˜å¿½ç•¥
                    }
                    
                    // æ£€æŸ¥æ˜¯å¦æ˜¯å½“å‰æ­£åœ¨åŠ è½½çš„ URL çš„é”™è¯¯
                    if (audio.src !== currentLoadingUrl && currentLoadingUrl !== '') {
                        return; // é™é»˜å¿½ç•¥æ—§éŸ³é¢‘çš„é”™è¯¯
                    }
                    
                    if (audioErrorHandled) {
                        return; // å·²å¤„ç†è¿‡ï¼Œå¿½ç•¥
                    }
                    
                    // æ£€æŸ¥æ˜¯å¦æœ‰çœŸæ­£çš„é”™è¯¯å¯¹è±¡
                    if (!audio.error) {
                        // æ²¡æœ‰é”™è¯¯å¯¹è±¡ï¼Œå¯èƒ½æ˜¯ CORS é—®é¢˜æˆ–å…¶ä»–ä¸´æ—¶çŠ¶æ€
                        // å¯¹äºè·¨åŸŸéŸ³é¢‘ï¼Œå°è¯•ä¸ä½¿ç”¨ crossOrigin é‡æ–°åŠ è½½
                        if (audio.crossOrigin && song.url.startsWith('http') && !song.url.includes(location.hostname)) {
                            const currentSrc = audio.src;
                            audio.crossOrigin = null;
                            audio.src = '';
                            setTimeout(() => {
                                if (currentSrc === currentLoadingUrl) { // ç¡®ä¿è¿˜æ˜¯å½“å‰æ­Œæ›²
                                    audio.src = currentSrc;
                                    audio.load();
                                }
                            }, 100);
                        }
                        return; // é™é»˜å¤„ç†
                    }
                    
                    audioErrorHandled = true;
                    
                    const errorCode = audio.error.code;
                    
                    // å¿½ç•¥ç”¨æˆ·ä¸­æ­¢çš„é”™è¯¯
                    if (errorCode === MediaError.MEDIA_ERR_ABORTED) {
                        return; // é™é»˜å¿½ç•¥
                    }
                    
                    // åªåœ¨ä¸¥é‡é”™è¯¯æ—¶è®°å½•å’Œæ˜¾ç¤º
                    if (errorCode === MediaError.MEDIA_ERR_SRC_NOT_SUPPORTED || 
                        errorCode === MediaError.MEDIA_ERR_DECODE) {
                        // åªåœ¨å¼€å‘ç¯å¢ƒæˆ–çœŸæ­£éœ€è¦æ—¶æ‰è®°å½•
                        if (errorCode === MediaError.MEDIA_ERR_SRC_NOT_SUPPORTED) {
                            uiTitle.innerText = song.title + ' (æ ¼å¼ä¸æ”¯æŒ)';
                        } else if (errorCode === MediaError.MEDIA_ERR_DECODE) {
                            uiTitle.innerText = song.title + ' (è§£ç é”™è¯¯)';
                        }
                    }
                    // ç½‘ç»œé”™è¯¯å’Œå…¶ä»–é”™è¯¯å®Œå…¨é™é»˜å¤„ç†ï¼Œä¸è¾“å‡ºä»»ä½•æ—¥å¿—
                }, 200); // å¢åŠ å»¶è¿Ÿï¼Œç¡®ä¿é”™è¯¯å¯¹è±¡å·²è®¾ç½®
            }, { once: true });
            
            // æ·»åŠ åŠ è½½æˆåŠŸç›‘å¬
            audio.addEventListener('loadedmetadata', function() {
                if (audio.src === currentLoadingUrl) {
                    console.log('éŸ³é¢‘å…ƒæ•°æ®åŠ è½½æˆåŠŸ:', song.url);
                    audioErrorHandled = false; // é‡ç½®é”™è¯¯æ ‡å¿—
                }
            }, { once: true });
            
            // é‡æ–°æ·»åŠ  timeupdate äº‹ä»¶ç›‘å¬å™¨ï¼ˆå› ä¸º audio å…ƒç´ è¢«æ›¿æ¢äº†ï¼‰
            audio.addEventListener('timeupdate', () => {
                const currentTime = audio.currentTime;
                
                // Update Progress Bar
                if (audio.duration) {
                    const percent = (currentTime / audio.duration) * 100;
                    progressBar.style.width = `${percent}%`;
                }

                // Update Lyrics
                if (parsedLyrics.length > 0) {
                    let activeIndex = -1;
                    for (let i = 0; i < parsedLyrics.length; i++) {
                        if (currentTime >= parsedLyrics[i].time) {
                            activeIndex = i;
                        } else {
                            break;
                        }
                    }

                    if (activeIndex !== -1) {
                        const lines = document.querySelectorAll('.lyric-line');
                        lines.forEach(l => l.classList.remove('active'));
                        
                        const activeLine = lines[activeIndex];
                        if (activeLine) {
                            activeLine.classList.add('active');
                            activeLine.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    }
                }
            });
            
            // é‡æ–°æ·»åŠ  ended äº‹ä»¶ç›‘å¬å™¨
            audio.addEventListener('ended', playNext);
            
            // é‡æ–°æ·»åŠ è¿›åº¦æ¡ç‚¹å‡»äº‹ä»¶ï¼ˆå¦‚æœè¿˜æ²¡æœ‰çš„è¯ï¼‰
            if (!progressContainer.hasAttribute('data-listener-added')) {
                progressContainer.setAttribute('data-listener-added', 'true');
                progressContainer.addEventListener('click', (e) => {
                    const width = progressContainer.clientWidth;
                    const clickX = e.offsetX;
                    const duration = audio.duration;
                    if (duration) {
                        audio.currentTime = (clickX / width) * duration;
                    }
                });
            }
            
            // é¢„åŠ è½½éŸ³é¢‘ï¼ˆä¸é˜»å¡ï¼‰
            audio.load();
            
            // é¢„ç¼“å­˜å½“å‰æ­Œæ›²ï¼ˆåå°è¿›è¡Œï¼Œä¸å½±å“æ’­æ”¾ï¼‰
            if (song.url && song.url.startsWith('http')) {
                precacheAudio(song.url).catch(() => {}); // é™é»˜å¤±è´¥
            }
            
            // Reset lyrics UI
            uiLyrics.innerHTML = '';
            parsedLyrics = parseLRC(song.lyrics);
            
            if (parsedLyrics.length === 0) {
                uiLyrics.innerHTML = '<p class="text-white/30 italic mt-20">No lyrics available</p>';
            } else {
                // Generate HTML for lyrics
                // Add empty space at top and bottom for center scrolling
                const padding = document.createElement('div');
                padding.className = "h-24";
                uiLyrics.appendChild(padding.cloneNode());
                
                parsedLyrics.forEach((line, i) => {
                    const p = document.createElement('p');
                    p.className = `lyric-line text-lg transition-all duration-300`;
                    p.innerText = line.text;
                    p.dataset.index = i;
                    p.dataset.time = line.time;
                    p.addEventListener('click', () => {
                        audio.currentTime = line.time;
                        playMusic();
                    });
                    uiLyrics.appendChild(p);
                });

                uiLyrics.appendChild(padding);
            }
        }

        function togglePlay() {
            if (audio.paused) {
                playMusic();
            } else {
                pauseMusic();
            }
        }

        function playMusic() {
            // ç¡®ä¿éŸ³é¢‘å·²åŠ è½½
            if (!audio.src) {
                const song = playlist[currentSongIndex];
                // ä½¿ç”¨ä¸ loadSong ç›¸åŒçš„ crossOrigin é€»è¾‘
                if (song.url.startsWith('http') && !song.url.includes(location.hostname)) {
                    audio.crossOrigin = null; // è·¨åŸŸéŸ³é¢‘ï¼Œä¸ä½¿ç”¨ crossOrigin
                } else {
                    audio.crossOrigin = 'anonymous'; // åŒåŸŸéŸ³é¢‘ï¼Œä½¿ç”¨ crossOrigin
                }
                audio.src = song.url;
                audio.load();
            }
            
            // æ£€æŸ¥éŸ³é¢‘æ˜¯å¦å¯æ’­æ”¾
            if (audio.readyState === 0 || audio.readyState < 2) {
                // éŸ³é¢‘æœªåŠ è½½æˆ–åŠ è½½ä¸­ï¼Œç­‰å¾…åŠ è½½å®Œæˆ
                const playWhenReady = () => {
                    if (audio.readyState >= 2) { // HAVE_CURRENT_DATA æˆ–æ›´é«˜
                        audio.play().then(() => {
                            isPlaying = true;
                            playIcon.className = 'fa-solid fa-pause text-2xl pl-0';
                            fabSpin.classList.remove('paused-spin');
                            albumArt.classList.remove('paused-spin');
                        }).catch(e => {
                            console.warn("æ’­æ”¾å¤±è´¥ï¼Œå¯èƒ½æ˜¯æµè§ˆå™¨è‡ªåŠ¨æ’­æ”¾ç­–ç•¥é™åˆ¶:", e);
                            // ä¸æ˜¾ç¤ºé”™è¯¯ï¼Œå› ä¸ºå¯èƒ½æ˜¯ç”¨æˆ·äº¤äº’é—®é¢˜
                        });
                    } else {
                        // ç»§ç»­ç­‰å¾…
                        setTimeout(playWhenReady, 100);
                    }
                };
                
                // ç›‘å¬ canplay äº‹ä»¶
                audio.addEventListener('canplay', function onCanPlay() {
                    audio.removeEventListener('canplay', onCanPlay);
                    playWhenReady();
                }, { once: true });
                
                // å¦‚æœå·²ç»å¯ä»¥æ’­æ”¾ï¼Œç›´æ¥æ’­æ”¾
                playWhenReady();
            } else {
                // éŸ³é¢‘å·²åŠ è½½ï¼Œç›´æ¥æ’­æ”¾
                audio.play().then(() => {
                    isPlaying = true;
                    playIcon.className = 'fa-solid fa-pause text-2xl pl-0';
                    fabSpin.classList.remove('paused-spin');
                    albumArt.classList.remove('paused-spin');
                }).catch(e => {
                    console.warn("æ’­æ”¾å¤±è´¥:", e);
                    // ä¸æ˜¾ç¤ºé”™è¯¯æç¤ºï¼Œå› ä¸ºå¯èƒ½æ˜¯æµè§ˆå™¨ç­–ç•¥æˆ–ç”¨æˆ·æ“ä½œé—®é¢˜
                });
            }
        }

        function pauseMusic() {
            audio.pause();
            isPlaying = false;
            playIcon.className = 'fa-solid fa-play text-2xl pl-1';
            fabSpin.classList.add('paused-spin');
            albumArt.classList.add('paused-spin');
        }

        function playNext() {
            currentSongIndex = (currentSongIndex + 1) % playlist.length;
            loadSong(currentSongIndex);
            playMusic();
        }

        function playPrev() {
            currentSongIndex = (currentSongIndex - 1 + playlist.length) % playlist.length;
            loadSong(currentSongIndex);
            playMusic();
        }

        // Sync Lyrics & Progress
        audio.addEventListener('timeupdate', () => {
            const currentTime = audio.currentTime;
            
            // Update Progress Bar
            if (audio.duration) {
                const percent = (currentTime / audio.duration) * 100;
                progressBar.style.width = `${percent}%`;
            }

            // Update Lyrics
            if (parsedLyrics.length > 0) {
                let activeIndex = -1;
                for (let i = 0; i < parsedLyrics.length; i++) {
                    if (currentTime >= parsedLyrics[i].time) {
                        activeIndex = i;
                    } else {
                        break;
                    }
                }

                if (activeIndex !== -1) {
                    const lines = document.querySelectorAll('.lyric-line');
                    lines.forEach(l => l.classList.remove('active'));
                    
                    const activeLine = lines[activeIndex];
                    if (activeLine) {
                        activeLine.classList.add('active');
                        activeLine.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }
            }
        });

        // Click on progress bar to seek
        progressContainer.addEventListener('click', (e) => {
            const width = progressContainer.clientWidth;
            const clickX = e.offsetX;
            const duration = audio.duration;
            audio.currentTime = (clickX / width) * duration;
        });

        audio.addEventListener('ended', playNext); // Auto play next

        // UI Controls
        playBtn.addEventListener('click', togglePlay);
        nextSongBtn.addEventListener('click', playNext);
        prevSongBtn.addEventListener('click', playPrev);

        // Open/Close Player
        function openPlayer() {
            musicOverlay.classList.remove('translate-y-full');
            musicFab.classList.add('scale-0'); // Hide FAB
        }
        function closePlayer() {
            musicOverlay.classList.add('translate-y-full');
            musicFab.classList.remove('scale-0'); // Show FAB
        }

        musicFab.addEventListener('click', openPlayer);
        minimizeBtn.addEventListener('click', closePlayer);
        closeMusicArea.addEventListener('click', closePlayer);


        // --- 3. EXISTING APP LOGIC (CALENDAR & AI) ---
        const apiKey = ""; // Environment provided
        
        async function generateGeminiText(prompt) {
            try {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                const payload = { contents: [{ parts: [{ text: prompt }] }] };
                const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                const data = await response.json();
                return data.candidates[0].content.parts[0].text;
            } catch (error) { return "AI is sleeping. Try again!"; }
        }

        async function generateGeminiSpeech(text) {
             try {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;
                const payload = {
                    contents: [{ parts: [{ text: text }] }],
                    generationConfig: { responseModalities: ["AUDIO"], speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Aoede" } } } }
                };
                const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                const data = await response.json();
                const audioContent = data.candidates[0].content.parts[0].inlineData.data;
                
                // Helper to play Raw PCM
                const binaryString = window.atob(audioContent);
                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) bytes[i] = binaryString.charCodeAt(i);
                
                const wavHeader = new Uint8Array(44);
                const view = new DataView(wavHeader.buffer);
                writeString(view, 0, 'RIFF'); view.setUint32(4, 36 + bytes.length, true); writeString(view, 8, 'WAVE');
                writeString(view, 12, 'fmt '); view.setUint32(16, 16, true); view.setUint16(20, 1, true); view.setUint16(22, 1, true);
                view.setUint32(24, 24000, true); view.setUint32(28, 48000, true); view.setUint16(32, 2, true); view.setUint16(34, 16, true);
                writeString(view, 36, 'data'); view.setUint32(40, bytes.length, true);
                
                const blob = new Blob([wavHeader, bytes], { type: 'audio/wav' });
                const player = document.getElementById('tts-player');
                player.src = URL.createObjectURL(blob);
                
                // Low volume for speech if music is playing
                if(isPlaying) audio.volume = 0.2;
                player.play();
                player.onended = () => { if(isPlaying) audio.volume = 1.0; };

            } catch (error) { console.error("TTS Error", error); }
        }
        function writeString(view, offset, string) { for (let i = 0; i < string.length; i++) view.setUint8(offset + i, string.charCodeAt(i)); }

        // Data & Elements
        const specialDates = {
            "10-20": { title: "Group Anniversary!", desc: "The day we all became best friends.", emoji: "ğŸ¥‚", type: "anniversary" },
            "10-25": { title: "Sarah's Birthday", desc: "Don't forget to buy cake!", emoji: "ğŸ‚", type: "birthday" },
            "11-25": { title: "Christmas Party", desc: "Secret Santa at John's house.", emoji: "ğŸ„", type: "holiday" }
        };

        const startScreen = document.getElementById('start-screen');
        const mainContent = document.getElementById('main-content');
        const enterBtn = document.getElementById('enter-btn');
        const calendarGrid = document.getElementById('calendar-grid');
        const monthYearLabel = document.getElementById('month-year');
        const modal = document.getElementById('event-modal');
        const modalContent = document.getElementById('modal-content');
        const prevBtn = document.getElementById('prev-month');
        const nextBtn = document.getElementById('next-month');
        const fortuneBtn = document.getElementById('fortune-btn');
        const dailyQuote = document.getElementById('daily-quote');

        let currentDate = new Date();
        let currentSelectedDate = null;

        // Initialization
        loadSong(0); // Load first song

        enterBtn.addEventListener('click', () => {
            playMusic(); // Start the playlist
            startScreen.style.opacity = '0';
            setTimeout(() => {
                startScreen.classList.add('hidden');
                mainContent.classList.remove('hidden');
                musicFab.classList.remove('hidden'); // Show music button
                void mainContent.offsetWidth; 
                mainContent.classList.remove('opacity-0');
                musicFab.classList.remove('opacity-0');
            }, 700);
        });

        // Calendar Render
        function renderCalendar(date) {
            calendarGrid.innerHTML = '';
            const year = date.getFullYear();
            const month = date.getMonth();
            const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            monthYearLabel.innerText = `${monthNames[month]} ${year}`;
            const firstDayIndex = new Date(year, month, 1).getDay();
            const lastDay = new Date(year, month + 1, 0).getDate();

            for (let x = firstDayIndex; x > 0; x--) {
                const div = document.createElement('div');
                div.className = "h-12 rounded-lg bg-white/5 flex items-center justify-center text-white/20";
                calendarGrid.appendChild(div);
            }
            const today = new Date();
            for (let i = 1; i <= lastDay; i++) {
                const dayKey = `${month}-${i}`;
                const isSpecial = specialDates[dayKey];
                const isToday = (i === today.getDate() && month === today.getMonth() && year === today.getFullYear());
                const cell = document.createElement('div');
                cell.className = `day-cell h-12 w-12 rounded-full flex flex-col items-center justify-center cursor-pointer relative mx-auto hover:bg-white/10 ${isToday ? 'bg-white/20 border border-white/50' : ''}`;
                cell.innerHTML = `<span class="text-sm font-bold">${i}</span>`;
                if (isSpecial) {
                    cell.classList.add('special-day-marker');
                    cell.style.backgroundColor = "rgba(255, 255, 255, 0.25)";
                    cell.innerHTML += `<span class="text-xs -mt-1 leading-none">${isSpecial.emoji}</span>`;
                }
                cell.addEventListener('click', () => handleDayClick(i, month, year, isSpecial));
                calendarGrid.appendChild(cell);
            }
        }

        // Event Handling
        function handleDayClick(day, month, year, specialEvent) {
            currentSelectedDate = { day, month, year };

            if (specialEvent) {
                if (typeof confetti === 'function') confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 }, colors: ['#FFD700', '#FF69B4', '#00CED1'] });
                document.getElementById('modal-emoji').innerText = specialEvent.emoji;
                document.getElementById('modal-title').innerText = specialEvent.title;
                document.getElementById('modal-desc').innerText = specialEvent.desc;
            } else {
                document.getElementById('modal-emoji').innerText = "ğŸ“…";
                document.getElementById('modal-title').innerText = `${month + 1}/${day}`;
                document.getElementById('modal-desc').innerText = "No plans yet.";
            }
            openModal();
        }

        // Features

        // æœ¬åœ°è¿åŠ¿åº“ - ç§¯æå‘ä¸Šçš„ä¸­æ–‡è¿åŠ¿
        const localFortunes = [
            "ä»Šæ—¥è¿åŠ¿æä½³ï¼Œé€‚åˆä¸å¥½å‹ä»¬ä¸€èµ·æ¢ç´¢æ–°äº‹ç‰©ï¼Œä¼šæœ‰æ„å¤–æƒŠå–œï¼",
            "ä»Šæ—¥è¿åŠ¿ä¸é”™ï¼Œæ˜¯é€‚åˆåˆ†äº«å¿«ä¹çš„å¥½æ—¥å­ï¼Œä¸æœ‹å‹ä»¬ä¸€èµ·åˆ›é€ ç¾å¥½å›å¿†å§ï¼",
            "ä»Šæ—¥è¿åŠ¿æ¬ ä½³ï¼Œä½†ä½ çš„æœ‹å‹ä¼šç»™ä½ å¸¦æ¥å¥½è¿ï¼Œä¸€èµ·è¡ŒåŠ¨å°†äº‹åŠåŠŸå€ï¼",
            "ä»Šæ—¥é€‚åˆä¸å¥½å‹ä»¬ä¸€èµ·æ”¾æ¾ï¼Œè½»æ¾çš„æ°›å›´ä¼šå¸¦æ¥æ–°çš„çµæ„Ÿï¼",
            "ä»Šæ—¥è¿åŠ¿å°šå¯ï¼Œä¸æœ‹å‹ä¸€èµ·èŠå¤©ä¼šå¸¦æ¥æ­£èƒ½é‡ï¼Œäº’ç›¸æ”¯æŒä¼šè®©æ¯ä¸ªäººéƒ½é—ªé—ªå‘å…‰ï¼",
            "ä»Šæ—¥è¿åŠ¿æä½³ï¼Œæ˜¯å»ºç«‹ç¾å¥½å›å¿†çš„ç»ä½³æ—¶æœºï¼Œä¸æœ‹å‹ä»¬ä¸€èµ·äº«å—å½“ä¸‹å§ï¼",
            "ä»Šæ—¥è¿åŠ¿æ—ºç››ï¼Œé€‚åˆä¸å¥½å‹ä»¬ä¸€èµ·å°è¯•æ–°æ´»åŠ¨ï¼Œä¼šæœ‰æ„æƒ³ä¸åˆ°çš„ä¹è¶£ï¼",
            "ä»Šæ—¥è¿åŠ¿æ¬ ä½³ï¼Œä½†ä½ çš„å‹è°Šä¼šå¸¦æ¥æ¸©æš–ï¼Œäº’ç›¸é™ªä¼´ä¼šè®©æ¯ä¸€å¤©éƒ½å˜å¾—ç‰¹åˆ«ï¼",
            "ä»Šæ—¥è¿åŠ¿å°šå¯ï¼Œæ˜¯å……æ»¡å¯èƒ½æ€§çš„æ—¥å­ï¼Œä¸æœ‹å‹ä»¬ä¸€èµ·æ¢ç´¢ï¼Œä¼šå‘ç°æ–°çš„æƒŠå–œï¼",
            "ä»Šæ—¥è¿åŠ¿æä½³ï¼Œä½ çš„ç²¾ç¥ä¼šè¾¾åˆ°é¡¶å³°ï¼Œå¿«å»ç¾¤é‡Œä¸æœ‹å‹ä¸€èµ·å¥½å¥½åˆ†äº«å§ï¼",
            "ä»Šæ—¥è¿åŠ¿æ—ºç››ï¼Œé€‚åˆä¸å¥½å‹ä»¬ä¸€èµ·åº†ç¥ï¼Œåˆ†äº«å¿«ä¹ä¼šè®©å¥½è¿åŠ å€ï¼",
            "ä»Šæ—¥æ˜¯å……æ»¡æ­£èƒ½é‡çš„ä¸€å¤©ï¼Œä¸æœ‹å‹ä»¬ä¸€èµ·ä¼šæ„Ÿå—åˆ°æ»¡æ»¡çš„å¹¸ç¦æ„Ÿï¼",
            "ä»Šæ—¥é€‚åˆä¸å¥½å‹ä»¬ä¸€èµ·æ”¾æ¾ï¼Œè½»æ¾çš„æ°›å›´ä¼šå¸¦æ¥æ–°çš„æƒ³æ³•ï¼",
            "ä»Šå¤©ä½ ä»¬çš„å›¢é˜Ÿä¼šå……æ»¡åˆ›æ„ï¼Œä¸€èµ·åˆä½œä¼šåˆ›é€ å‡ºä»¤äººæƒŠå–œçš„æˆæœï¼",
            "ä»Šæ—¥è¿åŠ¿æä½³ï¼Œé€‚åˆä¸æœ‹å‹ä»¬ä¸€èµ·å°è¯•æ–°äº‹ç‰©ï¼Œä¼šæœ‰ç¾å¥½çš„ä½“éªŒï¼"
        ];

        fortuneBtn.addEventListener('click', () => {
            fortuneBtn.innerHTML = `ğŸ”® é¢„æµ‹ä¸­...`;
            // æ¨¡æ‹Ÿå åœçš„å»¶è¿Ÿæ•ˆæœ
            setTimeout(() => {
                // éšæœºé€‰æ‹©ä¸€ä¸ªè¿åŠ¿
                const randomIndex = Math.floor(Math.random() * localFortunes.length);
                const text = localFortunes[randomIndex];
                document.getElementById('modal-emoji').innerText = "ğŸ”®";
                document.getElementById('modal-title').innerText = "ä»Šæ—¥è¿åŠ¿";
                document.getElementById('modal-desc').innerText = text;
                openModal();
                if(typeof confetti === 'function') confetti({ particleCount: 50, colors: ['#A020F0', '#FFFFFF'] });
                fortuneBtn.innerHTML = "ğŸ”® ä»Šæ—¥è¿åŠ¿";
            }, 500); // 500mså»¶è¿Ÿï¼Œå¢åŠ ä»ªå¼æ„Ÿ
        });


        // Utils
        function openModal() {
            modal.classList.remove('hidden');
            setTimeout(() => { modalContent.classList.remove('scale-95', 'opacity-0'); modalContent.classList.add('scale-100', 'opacity-100'); }, 10);
        }
        function closeModal() {
            modalContent.classList.remove('scale-100', 'opacity-100');
            modalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        prevBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(currentDate); });
        nextBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(currentDate); });
        modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });

        renderCalendar(currentDate);

    </script>
</body>
</html>
